## Race Condition (경쟁 상태)

### 정의 

공유 자원을 여러 프로세스가 동시에 읽거니 쓰는 상황 

접근의 타이밍이나 순서 등이 결과에 영향을 줄 수 있는 상태

- 공유 자원: 시스템 안에서 각 프로세스, 스레드가 함께 접근할 수 있는 모니터, 프린터, 메모리, 파일, 데이터 등의 자원이나 변수



### 임계 영역

여러 프로세스, 스레드가 공유 자원에 접근할 때 순서 등의 이유로 `결과가 달라지는 코드 영역`

해결 방법

- 뮤텍스, 세마포어, 모니터

충족 조건 3가지 (뮤, 세, 모)

1. 상호 배제 (Mutual Exclusion)

   한 프로세스가 임계 영역에 들어갔을 때 다른 프로세스는 들어갈 수 없다

2. 한정 대기(Bounded Waiting)

   특정 프로세스가 영원히 임계 영역에 들어가지 못하면 안 된다

   - 기아 상태 방지

3. 진행 or 융통성

   임계 영역에 들어간 프로세스가 있지 않은 상태에서 임계 영역에 들어가려는 프로세스가 있으면 들어가게 해주어야 한다

   임계영역에 있는 프로세스 외에는 다른 프로세스가 임계 영역에 진입하는 것을 방해하면 안된다



### 발생하는 경우

- **커널 코드 실행 중에 인터럽트가 발생할 경우**
  커널모드에서 데이터를 로드하여 작업을 하던 도중 인터럽트가 발생하여 같은 데이터를 조작하는 경우에 발생할 수 있다.
  **커널이 가진 전역변수는 모든 프로세스의 공유물**이므로 경쟁상태의 가능성이 있다.
  \- 커널모드에서 작업을 수행하는 동안 인터럽트를 disable시켜 인터럽트가 CPU제어권을 가져가지 못하도록 하여 해결할 수 있다.
- **프로세스가 시스템 콜을 하여 커널모드로 진입해서 작업을 수행하는 도중에 문맥 교환이 발생할 경우**
  프로세스1이 커널모드에서 데이터를 조작하던 도중 시간이 초과되어 CPU제어권이 프로세스2로 넘어가 같은 데이터를 조작하는 경우를 말한다.
  \- 프로세스가 커널모드에서 작업을 하는 경우에는 시간이 초과되더라도 CPU 제어권이 다른 프로세스에게 넘어가지 않도록 한다.
- **멀티 프로세서에서 공유 메모리 내의 커널 데이터에 접근할 경우**
  멀티프로세스 환경에서 2개의 CPU가 동시에 커널 내부의 공유 데이터에 접근하여 조작하는 경우에 발생할 수 있다.
  \- 커널 내부에 있는 각 공유 데이터에 접근할 때마다 그 데이터에 대해 lock/unlock함으로써 해결할 수 있다.

이밖에도 멀티스레드 환경에서 두 개 이상의 스레드가 공통의 전역변수에 접근할 경우 등에서 race condition이 발생할 수 있다



*참고*

- https://velog.io/@klloo/%EC%9A%B4%EC%98%81%EC%B2%B4%EC%A0%9C-%EA%B2%BD%EC%9F%81-%EC%83%81%ED%83%9C-Race-Condition
- https://zangzangs.tistory.com/115
- 면접을 위한 CS 전공지식 노트