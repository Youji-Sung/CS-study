# IP 프로토콜 구조

## IPv4 프로토콜

### IPv4가 하는 일

네트워크 상에서 데이터를 교환하기 위한 프로토콜

데이터가 **정확하게 전달될 것을 보장하지 않는다.**

* 데이터가 누락이되거나 깨질 수도 있다. -> 이는 다른 계층에서 보정이 된다.

중복된 패킷을 전달하거나 패킷의 순서를 잘못 전달할 가능성도 있다.

(악의적으로 이용되면 DoS 공격이 된다.)

데이터의 정확하고 순차적인 전달은 그보다 상위 프로토콜인 TCP에서 보장한다.



### IPv4 프로토콜의 구조

다른 네트워크의 특정 대상을 찾는 IPv4 프로토콜

![image-20220913190006293](6%EC%9E%A5_IPv4,ICMP_%ED%94%84%EB%A1%9C%ED%86%A0%EC%BD%9C.assets/image-20220913190006293.png)

IPv4 프로토콜은 20byte라고 생각하면 된다.

Option이 붙으면 하나당 4 byte씩 붙게된다. 최대 10개까지 붙을 수 있고 60byte까지 늘어날 수 있다.

**✔Source Address**: 출발지 IP주소

**✔ Destination Address**: 목적지 IP주소

**✔ Version**: 대체로 4가 온다. 4bit로 16진수 하나가 온다. 6이 오는 경우는 없다. IPv6은 모양이 다르기 때문이다.

**✔ IHL(Header Length)**: IPv4의 header의 길이. 최소 20byte에서 최대 60byte까지 커질 수 있다.

* 4bit로 표시한다. 16까지만 사용할 수 있다.
* 따라서 20~60 나누기 4를 해서 사용한다.

❗ 일반적으로 Version IHL은 4 5(16진수)가 온다고 생각하면 된다.

**✔ Type of Service (TOS)**: 과거에 사용하던 값으로 현재는 사용하지 않는다.

* 0으로 비워둔다. (16진수)

**✔ Total Length**: header의 길이를 입력하는 것이 아니라 payload까지의 길이를 의미

* 상위계층에서부터 캡슐화되어서 내려온 데이터의 길이까지를 합친 전체의 길이

**❗ Identification** & **IP Flags** & **Fragment Offset**은 하나의 set

* 큰 데이터를 보낼 때 최대 전송단위가 있기 때문에 잘게 쪼개서 보낸다.
* 이 때 사용되는 값들이다.
* 쪼개진 데이터들을 알아 볼 수 있게 하는 값

**✔ Identification:** id을 활용하여 쪼개진 데이터가 하나의 데이터임을 알아보기 위해서 id가 주어진다.

**✔ IP Flags:** 3bit로 이루어져 있다.

* x: 사용하지 않는다.
* D: Don't Fragment - 패킷을 보내는 사람이 데이터를 쪼개서 보내지 않는다라고 명시하는 것
  * 그러나 이렇게 하면 전송이 되지 않는다. 따라서 잘 사용하지 않는다.
* M: More Fragment 
  * IP Flag에서 주로 사용하는 것
  * 조각화가 되어있을 때 뒤에 패킷이 더 있다는 것을 상대방에게 알려주는 값
  * 최대 전송단위보다 큰 데이터라면 M이 1로 세팅된다.

**✔ Fragment Offset**: 13bit

* 조깨진 데이터를 복구할 때 데이터의 순서를 알아볼 수 있게 offset을 지정하는 것
* offset: 어느 기준으로부터 얼마만큼 떨어져 있다는 것을 의미
* 시작 부분부터 얼마만큼 떨어져 있는지 알 수 있다.
  * 첫번째 조각은 0

**✔ TTL(Time To Live)**: 패킷이 사라지는 시간을 지정

* 숫자값을 지정하고 0이 되는 순간 이 패킷을 버린다.
* 응용하면 상대방 컴퓨터의 운영체제을 알 수 있다.

**✔ Protocol**: Ethernet의 Ethernet type과 동일하게 상위프로토콜을 알려주는 것

* ICMP(3계층): 01
* TCP(4계층): 06
* UDP(4계층): 17

**✔ Header Checksum**: header에 오류가 있는지 확인하는 값

* Header의 필드들로 값을 계산하고 setting하여 보낸다. 
* 받는 쪽에서 setting된 값을 다시 계산해서 Header Checksum의 값과 비교한다.



## ICMP 프로토콜

### ICMP가 하는 일

ICMP (Internet Control Message Protocol, 인터넷 메시지 프로토콜)

네트워크 컴퓨터 위에서 돌아가는 운영체제에서 **오류 메시지**를 전송 받는 데 주로 쓰인다.

프로토콜 구조의 Type과 Code를 통해 오류 메시지를 전송 받는다.

* 인터넷 상에서 제어메시지를 주고 받는 프로토콜
* 상대방 통신이 되는지 확인할 때 사용하는 프로토콜



### ICMP 프로토콜의 구조

특정 대상과 내가 통신이 잘되는지 확인하는 ICMP 프로토콜

![image-20220913193843501](6%EC%9E%A5_IPv4,ICMP_%ED%94%84%EB%A1%9C%ED%86%A0%EC%BD%9C.assets/image-20220913193843501.png)

**✔ Type**: 카테고리(대분류)

* 종류가 다양하다.
  * 알아둘 것
  * 0: Echo Reply - 상대방과 통신 확인**(응답)**
  * 3: Destination Unreachable
    * 목적지까지 가지 못한 경우
    * 경로상의 문제
  * 5: Redirect
    * 상대방의 라우팅 테이블은 원격지에서 수정하는 것
    * 보안상 중요하다.
  * 8: Echo - 상대방과 통신 확인**(요청)**
  * 11: Time Exceded **요청시간 만료**
    * 목적지까지 도달했으나 응답을 받지 못한 경우
    * 상대방의 문제

**✔ Code**: 소분류

**✔ Checksum**: header에 오류가 있는지 확인하기 위한 값



## 라우팅 테이블

### 내가 보낸 패킷은 어디로 가는가

어디로 보내야 하는지 설정되어 있는 라우팅 테이블

`netstat -r`로 확인 가능

![image-20220913194514909](6%EC%9E%A5_IPv4,ICMP_%ED%94%84%EB%A1%9C%ED%86%A0%EC%BD%9C.assets/image-20220913194514909.png)

✔ 라우팅 테이블에 적혀 있는 네트워크 대역만 찾아갈 수 있다.

✔ 기본 0.0.0.0을 설정해준다.



## 다른 네트워크와 통신 과정

### 다른 네트워크까지 내 패킷의 이동 과정

내 컴퓨터에서 보낸 패킷이 다른 네트워크의 컴퓨터까지 어떻게 이동하는 가

![image-20220913194653524](6%EC%9E%A5_IPv4,ICMP_%ED%94%84%EB%A1%9C%ED%86%A0%EC%BD%9C.assets/image-20220913194653524.png)

네크워크 대역이 네개로 나눠져 있는 모습이다.

**A가 B와 통신하려한다.**

#### A

![image-20220913194843753](6%EC%9E%A5_IPv4,ICMP_%ED%94%84%EB%A1%9C%ED%86%A0%EC%BD%9C.assets/image-20220913194843753.png)

✔ A의 라우팅 테이블에 B의 네트워크 대역이 존재해야 통신이 가능하다.



**Eth|IPv4|ICMP요청**

✔ ICMP요청작성 ![image-20220913195106269](6%EC%9E%A5_IPv4,ICMP_%ED%94%84%EB%A1%9C%ED%86%A0%EC%BD%9C.assets/image-20220913195106269.png)

* ICMP 프로토콜의 상태 : 요청(08)

✔ IP 프로토콜 작성 ![image-20220913195148106](6%EC%9E%A5_IPv4,ICMP_%ED%94%84%EB%A1%9C%ED%86%A0%EC%BD%9C.assets/image-20220913195148106.png)

✔ Ethernet 프로토콜의 목적지 MAC주소![image-20220913195425031](6%EC%9E%A5_IPv4,ICMP_%ED%94%84%EB%A1%9C%ED%86%A0%EC%BD%9C.assets/image-20220913195425031.png)

* 공유기1의 MAC주소(cc:cc:cc:cc:cc:cc)

* Ethernet은 가까운 곳에서만 통신을 하므로 가까운 곳에서 갈 수 있는 데까지만 써놓음
* 따라서 bb:bb:bb:bb:bb:bb가 아닌 cc:cc:cc:cc:cc:cc



#### 스위치

![image-20220913195515490](6%EC%9E%A5_IPv4,ICMP_%ED%94%84%EB%A1%9C%ED%86%A0%EC%BD%9C.assets/image-20220913195515490.png)

2계층까지 확인: C로 간다.

패킷이 A 👉 스위치(컴퓨터와 공유기 사이에 있는 애) 👉 공유기1 순서로 전달 (이때 스위치는 2계층 장비이므로 Ethernet 프로토콜만 확인)



![image-20220913195703882](6%EC%9E%A5_IPv4,ICMP_%ED%94%84%EB%A1%9C%ED%86%A0%EC%BD%9C.assets/image-20220913195703882.png)

#### 공유기1

공유기1에서 목적지 IP주소를 확인한 후 공유기1의 라우팅 테이블을 확인하여 Ethernet 프로토콜을 다시 만든다.

목적지 MAC주소와 출발지 MAC주소를 자기의 옆에 있는 네트워크 대역에서 통신할 수 있도록 바꾼다.

**✔ Ethernet프로토콜**![image-20220913195859393](6%EC%9E%A5_IPv4,ICMP_%ED%94%84%EB%A1%9C%ED%86%A0%EC%BD%9C.assets/image-20220913195859393.png)



#### 라우터

라우터에서도 Ethernet프로토콜과 IP 프로토콜 확인 후 IP 프로토콜의 목적지 MAC 주소와 자신의 라우팅 테이블 확인한다.

Ethernet 프로토콜 주소 새로 작성한다.



#### ✔ Ethernet프로토콜은 네트워크 대역이 바뀔 때마다 새로 작성된다.



#### 공유기2

공유기2가 패킷을 받고 IP주소를 확인하고 라우팅 테이블을 확인한 후 Ethernet 프로토콜을 다시 작성한다.

스위치에게 전달한다.

**✔ Ethernet프로토콜**![image-20220913200144961](6%EC%9E%A5_IPv4,ICMP_%ED%94%84%EB%A1%9C%ED%86%A0%EC%BD%9C.assets/image-20220913200144961.png)

#### 스위치

스위치는 공유기2에서 받아 B에게 전달한다.



#### B

B는 ICMP요청이 온것을 확인한다.![image-20220913200406251](6%EC%9E%A5_IPv4,ICMP_%ED%94%84%EB%A1%9C%ED%86%A0%EC%BD%9C.assets/image-20220913200406251.png)

B는 응답 패킷을 만들어 A에게 ICMP의 상태가 응답(0) 패킷 전달. ![image-20220913200455687](6%EC%9E%A5_IPv4,ICMP_%ED%94%84%EB%A1%9C%ED%86%A0%EC%BD%9C.assets/image-20220913200455687.png)



동일한 방법으로 A로 돌아간다.

이를 통해 A가 B와 통신된 것을 알게 된다.

ping명령어를 쳤을 때 이 과정(왕복)이 4번이루어진다.



❗ 처음에 A가 B에 요청을 하려는데 공유기1의 MAC 주소를 모르면 ARP로 공유기의 MAC주소를 알아온 다음 요청을 시도해야한다. 

❗ 공유기1에서 라우터의 MAC 주소 모를 땐 ARP로 MAC 주소 알아온 다음 다시 Ethernet 프로토콜 바꿔서 패킷 전송한다.



## IPv4의 조각화

### 조각화란?

큰 IP 패킷들이 적은 **MTU**(Maximum Transmission Unit)를 갖는 링크를 통하여 전송되려면 **여러개의 작은 패킷으로 쪼개어/조각화 되어 전송**돼야 한다.

* 최대 전송 단위

즉, 목적지까지 패킷을 전달하는 과정에 통과하는 각 라우터마다 전송에 적합한 프레임으로 변환이 필요하다.

일단 조각화되면, 최종 목적지에 도달할 때까지 재조립되지 않는 것이 일반적이다.

IPv4에서는 발신지 뿐만 아니라 중간 라우터에서도 IP 조각화가 가능하다.

IPv6에서는 IP 단편화가 발신지에서만 가능하다.

재조립은 항상 최종 수신지에서만 가능하다.



여러 개의 패킷으로 조각화된 패킷

**조각화의 과정 (두번 이루어지는 그림)**

![image-20220913200849290](6%EC%9E%A5_IPv4,ICMP_%ED%94%84%EB%A1%9C%ED%86%A0%EC%BD%9C.assets/image-20220913200849290.png)
